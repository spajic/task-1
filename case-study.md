# Case-study оптимизации

## Актуальная проблема
В нашем проекте возникла серьёзная проблема.

Необходимо было обработать файл с данными, чуть больше ста мегабайт.

У нас уже была программа на `ruby`, которая умела делать нужную обработку.

Она успешно работала на файлах размером пару мегабайт, но для большого файла она работала слишком долго, и не было понятно, закончит ли она вообще работу за какое-то разумное время.

Я решил исправить эту проблему, оптимизировав эту программу.

## Формирование метрики
Для того, чтобы понимать, дают ли мои изменения положительный эффект на быстродействие программы я придумал использовать такую метрику:
Для 1мб файла: необходимо 156Мб памяти, парсинг проходит за 37 сек.

## Гарантия корректности работы оптимизированной программы
Программа поставлялась с тестом. Выполнение этого теста позволяет не допустить изменения логики программы при оптимизации.

## Feedback-Loop
Для того, чтобы иметь возможность быстро проверять гипотезы я выстроил эффективный `feedback-loop`, который позволил мне получать обратную связь по эффективности сделанных изменений моментально

Вот как я построил `feedback_loop`: я проверял обратку файла на разные метрики, 1 изменение - 1 коммит, если изменение дало нужный результат

## Вникаем в детали системы, чтобы найти 20% точек роста
Для того, чтобы найти "точки роста" для оптимизации я воспользовался memory_profiler, stackprof, ruby-prof, QCacheGrind

Вот какие проблемы удалось найти и решить

### Ваша находка №1
Большое выделение памяти при работе с классами:
 * Array
 * String
 * Hash

### Ваша находка №2
Основное процессорное время уходило на обработку массивов (Array#each, Array#map), на сбор данных (Object#collect_stats_from_users)
и конкатенацию строк (String#split)

### Ваша находка №3
Долго происходил процесс обработки сессий для каждого пользователя

## Результаты
В результате проделанной оптимизации наконец удалось обработать файл с данными.
Удалось улучшить метрику системы с:
* memory
allocated memory by class
-----------------------------------
293_586_874_4  Array
  436_974_43  String
  260_091_68  Hash
   867_291_2  MatchData
   162_813_6  Date
Total allocated: 301_605_315_2 bytes (1325648 objects)
* cpu
100.00% 	0.00% 	1405386.00 	11.00 	0.00 	1405375.00 	1 	Object#work
* time
1mb: Finish in 37.34
~128mb: infinity

на:
* memory
allocated memory by class
-----------------------------------
  326_126_88  String
  204_421_52  MatchData
  161_736_32  Hash
   768_498_4  Array
   162_813_6  Date
    163_120  User
Total allocated: 787_261_33 bytes (857028 objects)
* cpu
100.00% 	0.00% 	857034.00 	7.00 	0.00 	857027.00 	1 	Object#work 
* time
1mb: Finish in 0.6
~128Mb: Finish in 110.46

## Защита от регресса производительности
Для защиты от потери достигнутого прогресса при дальнейших изменениях программы сделано *ничего* :)
